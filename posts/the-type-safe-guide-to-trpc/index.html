<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The type-safe guide to tRPC | celeronCoder's Blog</title><meta name=keywords content="nextjs,prisma,tRPC"><meta name=description content="tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation."><meta name=author content><link rel=canonical href=https://celeroncoder.github.io/blog/posts/the-type-safe-guide-to-trpc/><link crossorigin=anonymous href=/blog/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/blog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://raw.githubusercontent.com/gist/celeronCoder/bf4dbcc95f3919e2b374dc60b0c01391/raw/efe5fe3f1cfad1dd862fdbefd760f1815c6d2a1a/favicon.svg><link rel=icon type=image/png sizes=16x16 href=https://celeroncoder.github.io/blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://celeroncoder.github.io/blog/favicon-32x32.png><link rel=apple-touch-icon href=https://celeroncoder.github.io/blog/apple-touch-icon.png><link rel=mask-icon href=https://celeroncoder.github.io/blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="The type-safe guide to tRPC"><meta property="og:description" content="tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation."><meta property="og:type" content="article"><meta property="og:url" content="https://celeroncoder.github.io/blog/posts/the-type-safe-guide-to-trpc/"><meta property="og:image" content="https://celeroncoder.github.io/blog/uploads/trpcblog.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-27T18:30:00+00:00"><meta property="article:modified_time" content="2022-07-27T18:30:00+00:00"><meta property="og:site_name" content="celeronCoder"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://celeroncoder.github.io/blog/uploads/trpcblog.png"><meta name=twitter:title content="The type-safe guide to tRPC"><meta name=twitter:description content="tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://celeroncoder.github.io/blog/posts/"},{"@type":"ListItem","position":3,"name":"The type-safe guide to tRPC","item":"https://celeroncoder.github.io/blog/posts/the-type-safe-guide-to-trpc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The type-safe guide to tRPC","name":"The type-safe guide to tRPC","description":"tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation.","keywords":["nextjs","prisma","tRPC"],"articleBody":"This isn’t the best guide to use tRPC, probably there are better ways to do this, like create-t3-app, the best I could find.\nMost of what is here is from the tRPC’s documentation, you can refer them, super helpful and easy to read.\nWhat is tRPC?\ntRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation.\nWhere to use?\nCreate the typed server and then import its type and use it with an adaptor in the client side.\nHow does it implement type-safety?\ntRPC encourages using the zod, a library for type validation of input and output arguments.\nIs tRPC only limited to React?\ntRPC’s core API is built to work with any client, but right now it supports React and can be used with React Meta Frameworks like NextJS or SolidJS, since it uses React Query under the hood to talk to the server and maintaining type-safety across the data-pipeline or data-flow.\nFor now, it has first-party adaptors for React, NextJS, Express, Fastify, SolidJS, and some community packages like for tRPC for SveleteKit\nWhat are its features?\nLightweight, a tiny bundle size for such a powerful library. Type-safe to the max! Support subscriptions with websockets library. Request batching Request can be made simultaneously and then are batched into one. Strong User base and helpful Community tRPC x NextJS Recommended file structure:\n. ├── prisma # \u003c-- if prisma is added │ └── [..] ├── src │ ├── pages │ │ ├── _app.tsx # \u003c-- add `withTRPC()`-HOC here │ │ ├── api │ │ │ └── trpc │ │ │ └── [trpc].ts # \u003c-- tRPC HTTP handler │ │ └── [..] │ ├── server # \u003c-- can be named backend or anything else │ │ ├── routers │ │ │ ├── app.ts # \u003c-- main app router │ │ │ ├── post.ts # \u003c-- sub routers │ │ │ └── [..] │ │ ├── context.ts # \u003c-- create app context │ │ └── createRouter.ts # \u003c-- router helper │ └── utils │ └── trpc.ts # \u003c-- your typesafe tRPC hooks └── [..] Components Router\nThis is the router where the actual business logic will reside, create a backend folder inside the src directory and put all this stuff there.\nIf using prisma otherwise this is optional, src/server/utils/prisma.ts\nimport { PrismaClient } from \"@prisma/client\"; declare global { var prisma: PrismaClient | undefined; }; export const prisma = global.prisma || new PrismaClient({ log: [\"query\"] }); if (process.env.NODE_ENV != 'production') global.prisma = prisma; src/server/router/context.ts\nimport * as trpc from \"@trpc/server\"; import * as trpcNext from \"@trpc/server/adapters/next\"; import { prisma } from \"@/server/utils/prisma\"; // this is optional export const createContext = async ( options?: trpcNext.CreateNextContextOptions ) =\u003e { const req = options?.req; const res = options?.res; return { req, res, prisma, // this is optional }; }; type Context = trpc.inferAsyncReturnType\u003ctypeof createContext\u003e; export const createRouter = () =\u003e trpc.router\u003cContext\u003e(); Using Contexts\nWe can create router without using the above context by just using trpc.router() that will work just fine. But if you are using some external API like in the above case we are using prisma, it’s better to use pass in repeatedly used instances to context to avoid having multiple ones for every query we use that in, that may affect our performance and can also be vulnerable.\nsrc/server/router/index.ts\nimport {createRouter} from \"./contex\"; import {exampleRouter} from \"./example.router\"; export const appRouter = createRouter() .merge(\"example.\", exampleRouter) .query(\"posts.count\", { async resolve({ctx}) { return await ctx.prisma.patient.count(); } }); export type AppRouter = typeof appRouter; API handler aka NextJS adaptor:\nThe exact filename is necessary to make this work!\nsrc/pages/api/trpc/[trpc].ts\nimport * as trpcNext from \"@trpc/server/adapters/next\"; import { appRouter, AppRouter } from \"@/backend/router\"; import { inferProcedureOutput } from \"@trpc/server\"; import { createContext } from \"@/backend/router/context\"; // export API handler export default trpcNext.createNextApiHandler({ router: appRouter, createContext: createContext, }); Hooks These are the React hooks necessary to maintain the type-safety, this will give you React Query like hooks to fetch the API.\nsrc/utils/trpc.ts\nimport { createReactQueryHooks } from \"@trpc/react\"; import type { AppRouter } from \"@/backend/router\"; import { inferProcedureOutput } from \"@trpc/server\"; export const trpc = createReactQueryHooks\u003cAppRouter\u003e(); export type TQuery = keyof AppRouter[\"_def\"][\"queries\"]; // helper type to infer query output export type InferQueryOutput\u003cTRouteKey extends TQuery\u003e = inferProcedureOutput\u003c AppRouter[\"_def\"][\"queries\"][TRouteKey] \u003e; Example query in React Component Now that tRPC is set up, this is how we use it inside react components.\nsrc/pages/index.tsx\n// we use the instance we created that has our router type definitions import { trpc } from \"@/utils/trpc\"; export default SomePage() { const { isLoading, data:postsCount } = trpc.useQuery([\"posts.count\"]); return \u003cdiv\u003e...\u003c/div\u003e } SSG Helpers SSG Helpers are helper functions that can be used to pre-fetch queries on the server upon request to reduce loading time.\nThey are to be used when working with SSR and SSG or ISR.\nHow to use it with getServideSideProps function of NextJS pages.\n// /pages/posts/[id].tsx export function getServerSideProps( context: GetServerSidePropsContext\u003c{id: string}\u003e ) { const { id } = context.params; const ssg = createSSGHelpers({ router: appRouter, ctx: await createContext(), // { } if no context in your router transformer: superjson }); ssg.fetchQuery(\"posts.get\", {id}); return { props: { trpcState: ssg.dehydrate(), id } } } export default function PostPage(props: InferGetServerSidePropsType\u003ctypeof getServerSideProps\u003e) { const {id} = props; // this query will be fetched instantly because of the cached // response of the query we fetching on server const {isLoading, data} = trpc.useQuery([\"posts.get\"], {id}) return ... } References\nCheck out this amazing talk by Theo on tRPC vs GraphQL and their risks. Check out Theo on YouTube or any other social media platform, he has a lot of content about tRPC Follow Alex aka Katt, the creator of tRPC. ","wordCount":"944","inLanguage":"en","image":"https://celeroncoder.github.io/blog/uploads/trpcblog.png","datePublished":"2022-07-27T18:30:00Z","dateModified":"2022-07-27T18:30:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://celeroncoder.github.io/blog/posts/the-type-safe-guide-to-trpc/"},"publisher":{"@type":"Organization","name":"celeronCoder's Blog","logo":{"@type":"ImageObject","url":"https://raw.githubusercontent.com/gist/celeronCoder/bf4dbcc95f3919e2b374dc60b0c01391/raw/efe5fe3f1cfad1dd862fdbefd760f1815c6d2a1a/favicon.svg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://celeroncoder.github.io/blog accesskey=h title="celeronCoder's Blog (Alt + H)">celeronCoder's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://celeroncoder.github.io/blog>Home</a>&nbsp;»&nbsp;<a href=https://celeroncoder.github.io/blog/posts/>Posts</a></div><h1 class=post-title>The type-safe guide to tRPC</h1><div class=post-description>tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation.</div><div class=post-meta><span title='2022-07-27 18:30:00 +0000 UTC'>July 27, 27030</span>&nbsp;·&nbsp;5 min</div></header><figure class=entry-cover><img loading=lazy src=https://celeroncoder.github.io/blog/uploads/trpcblog.png alt=trpcBlogCover></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#trpc-x-nextjs>tRPC x NextJS</a><ul><li><a href=#components>Components</a></li><li><a href=#ssg-helpers>SSG Helpers</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>This isn&rsquo;t the best guide to use tRPC, probably there are better ways to do this, like <a href=https://create.t3.gg/>create-t3-app</a>, the best I could find.</p><p>Most of what is here is from the <a href=https://trpc.io/docs>tRPC&rsquo;s documentation</a>, you can refer them, super helpful and easy to read.</p><p><strong>What is tRPC?</strong></p><p>tRPC is a typescript library, so to say, that makes it easy to create type-safe APIs without schema or any sort of code generation.</p><p><strong>Where to use?</strong></p><p>Create the <em>typed server</em> and then import its type and use it with an adaptor in the client side.</p><p><strong>How does it implement type-safety?</strong></p><p>tRPC encourages using the <a href=https://www.npmjs.com/package/zod>zod</a>, a library for type validation of input and output arguments.</p><p><strong>Is tRPC only limited to React?</strong></p><p>tRPC&rsquo;s core API is built to work with any client, but right now it supports <strong>React</strong> and can be used with <strong>React Meta Frameworks</strong> like <strong>NextJS</strong> or <strong>SolidJS</strong>, since it uses <strong>React Query</strong> under the hood to talk to the server and maintaining type-safety across the data-pipeline or data-flow.</p><p>For now, it has first-party adaptors for <strong>React</strong>, <strong>NextJS</strong>, <strong>Express</strong>, <strong>Fastify</strong>, <strong>SolidJS</strong>, and some community packages like for <a href=https://github.com/icflorescu/trpc-sveltekit><strong>tRPC for SveleteKit</strong></a></p><p><strong>What are its features?</strong></p><ul><li>Lightweight, a tiny bundle size for such a powerful library.</li><li>Type-safe to the max!</li><li>Support subscriptions with <strong>websockets</strong> library.</li><li>Request batching<ul><li>Request can be made simultaneously and then are batched into one.</li></ul></li><li>Strong User base and helpful Community</li></ul><h2 id=trpc-x-nextjs>tRPC x NextJS<a hidden class=anchor aria-hidden=true href=#trpc-x-nextjs>#</a></h2><p>Recommended file structure:</p><pre tabindex=0><code class=language-tree data-lang=tree>.
├── prisma # &lt;-- if prisma is added
│   └── [..]
├── src
│   ├── pages
│   │   ├── _app.tsx # &lt;-- add `withTRPC()`-HOC here
│   │   ├── api
│   │   │   └── trpc
│   │   │       └── [trpc].ts # &lt;-- tRPC HTTP handler
│   │   └── [..]
│   ├── server # &lt;-- can be named backend or anything else
│   │   ├── routers
│   │   │   ├── app.ts   # &lt;-- main app router
│   │   │   ├── post.ts  # &lt;-- sub routers
│   │   │   └── [..]
│   │   ├── context.ts      # &lt;-- create app context
│   │   └── createRouter.ts # &lt;-- router helper
│   └── utils
│       └── trpc.ts  # &lt;-- your typesafe tRPC hooks
└── [..]
</code></pre><h3 id=components>Components<a hidden class=anchor aria-hidden=true href=#components>#</a></h3><p><strong>Router</strong></p><p>This is the router where the actual business logic will reside, create a <code>backend</code> folder inside the <code>src</code> directory and put all this stuff there.</p><p>If using prisma otherwise this is optional,
<code>src/server/utils/prisma.ts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>PrismaClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@prisma/client&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>declare</span> <span style=color:#66d9ef>global</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>prisma</span>: <span style=color:#66d9ef>PrismaClient</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>prisma</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>global</span>.<span style=color:#a6e22e>prisma</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PrismaClient</span>({
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;query&#34;</span>]
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>NODE_ENV</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;production&#39;</span>) <span style=color:#66d9ef>global</span>.<span style=color:#a6e22e>prisma</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>prisma</span>;
</span></span></code></pre></div><p><code>src/server/router/context.ts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>trpc</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/server&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>trpcNext</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/server/adapters/next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>prisma</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@/server/utils/prisma&#34;</span>; <span style=color:#75715e>// this is optional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createContext</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>options?</span>: <span style=color:#66d9ef>trpcNext.CreateNextContextOptions</span>
</span></span><span style=display:flex><span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>req</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>res</span>;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>res</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>prisma</span>, <span style=color:#75715e>// this is optional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	};
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>trpc</span>.<span style=color:#a6e22e>inferAsyncReturnType</span>&lt;<span style=color:#f92672>typeof</span> <span style=color:#a6e22e>createContext</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createRouter</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>trpc</span>.<span style=color:#a6e22e>router</span>&lt;<span style=color:#f92672>Context</span>&gt;();
</span></span></code></pre></div><blockquote><p><strong>Using Contexts</strong></p><p>We can create router without using the above context by just using <code>trpc.router()</code> that will work just fine. But if you are using some external API like in the above case we are using prisma, it&rsquo;s better to use pass in repeatedly used instances to context to avoid having multiple ones for every query we use that in, that may <em>affect our performance and can also be vulnerable</em>.</p></blockquote><p><code>src/server/router/index.ts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>createRouter</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./contex&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {<span style=color:#a6e22e>exampleRouter</span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;./example.router&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>appRouter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createRouter</span>()
</span></span><span style=display:flex><span>	.<span style=color:#a6e22e>merge</span>(<span style=color:#e6db74>&#34;example.&#34;</span>, <span style=color:#a6e22e>exampleRouter</span>)
</span></span><span style=display:flex><span>	.<span style=color:#a6e22e>query</span>(<span style=color:#e6db74>&#34;posts.count&#34;</span>, {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>resolve</span>({<span style=color:#a6e22e>ctx</span>}) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>prisma</span>.<span style=color:#a6e22e>patient</span>.<span style=color:#a6e22e>count</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppRouter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>appRouter</span>;
</span></span></code></pre></div><p><strong>API handler</strong> aka NextJS adaptor:</p><blockquote><p>The exact filename is necessary to make this work!</p></blockquote><p><code>src/pages/api/trpc/[trpc].ts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>trpcNext</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/server/adapters/next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>appRouter</span>, <span style=color:#a6e22e>AppRouter</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@/backend/router&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>inferProcedureOutput</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/server&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@/backend/router/context&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// export API handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>trpcNext</span>.<span style=color:#a6e22e>createNextApiHandler</span>({
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span>: <span style=color:#66d9ef>appRouter</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createContext</span>: <span style=color:#66d9ef>createContext</span>,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p><strong>Hooks</strong>
These are the React hooks necessary to maintain the type-safety, this will give you React Query like hooks to fetch the API.</p><p><code>src/utils/trpc.ts</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createReactQueryHooks</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/react&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#66d9ef>type</span> { <span style=color:#a6e22e>AppRouter</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@/backend/router&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>inferProcedureOutput</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@trpc/server&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>trpc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createReactQueryHooks</span>&lt;<span style=color:#f92672>AppRouter</span>&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TQuery</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>keyof</span> <span style=color:#a6e22e>AppRouter</span>[<span style=color:#e6db74>&#34;_def&#34;</span>][<span style=color:#e6db74>&#34;queries&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// helper type to infer query output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InferQueryOutput</span>&lt;<span style=color:#f92672>TRouteKey</span> <span style=color:#a6e22e>extends</span> <span style=color:#a6e22e>TQuery</span>&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>inferProcedureOutput</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>AppRouter</span>[<span style=color:#e6db74>&#34;_def&#34;</span>][<span style=color:#e6db74>&#34;queries&#34;</span>][<span style=color:#a6e22e>TRouteKey</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>;
</span></span></code></pre></div><p><strong>Example query in React Component</strong>
Now that tRPC is set up, this is how we use it inside react components.</p><p><code>src/pages/index.tsx</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#75715e>// we use the instance we created that has our router type definitions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>trpc</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@/utils/trpc&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>SomePage() {</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>isLoading</span>, <span style=color:#a6e22e>data</span>:<span style=color:#66d9ef>postsCount</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>trpc</span>.<span style=color:#a6e22e>useQuery</span>([<span style=color:#e6db74>&#34;posts.count&#34;</span>]);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>div</span>&gt;...&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=ssg-helpers>SSG Helpers<a hidden class=anchor aria-hidden=true href=#ssg-helpers>#</a></h3><p>SSG Helpers are helper functions that can be used to pre-fetch queries on the server upon request to reduce loading time.</p><p>They are to be used when working with SSR and SSG or ISR.</p><p>How to use it with <code>getServideSideProps</code> function of NextJS pages.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// /pages/posts/[id].tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getServerSideProps</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>GetServerSidePropsContext</span><span style=color:#f92672>&lt;</span>{<span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>}<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>id</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>params</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ssg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createSSGHelpers</span>({
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>router</span>: <span style=color:#66d9ef>appRouter</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>: <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>createContext</span>(), <span style=color:#75715e>// { } if no context in your router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>transformer</span>: <span style=color:#66d9ef>superjson</span>
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ssg</span>.<span style=color:#a6e22e>fetchQuery</span>(<span style=color:#e6db74>&#34;posts.get&#34;</span>, {<span style=color:#a6e22e>id</span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>trpcState</span>: <span style=color:#66d9ef>ssg.dehydrate</span>(),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>PostPage</span>(<span style=color:#a6e22e>props</span>: <span style=color:#66d9ef>InferGetServerSidePropsType</span>&lt;<span style=color:#f92672>typeof</span> <span style=color:#a6e22e>getServerSideProps</span>&gt;) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>id</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>props</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// this query will be fetched instantly because of the cached
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// response of the query we fetching on server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>const</span> {<span style=color:#a6e22e>isLoading</span>, <span style=color:#a6e22e>data</span>} <span style=color:#f92672>=</span> <span style=color:#a6e22e>trpc</span>.<span style=color:#a6e22e>useQuery</span>([<span style=color:#e6db74>&#34;posts.get&#34;</span>], {<span style=color:#a6e22e>id</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>References</strong></p><ul><li>Check out <a href="https://www.youtube.com/watch?v=I5tWWYBdlJo">this</a> amazing talk by <a href=https://twitter.com/t3dotgg>Theo</a> on tRPC vs GraphQL and their risks.</li><li>Check out Theo on YouTube or any other social media platform, he has a lot of content about tRPC</li><li>Follow <a href=https://twitter.com/alexdotjs>Alex</a> aka Katt, the creator of tRPC.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://celeroncoder.github.io/blog/tags/nextjs/>nextjs</a></li><li><a href=https://celeroncoder.github.io/blog/tags/prisma/>prisma</a></li><li><a href=https://celeroncoder.github.io/blog/tags/trpc/>tRPC</a></li></ul><nav class=paginav><a class=next href=https://celeroncoder.github.io/blog/posts/spinning-up-mysql-database-with-docker/><span class=title>Next »</span><br><span>Spinning up MySQL Database with Docker</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://celeroncoder.github.io/blog>celeronCoder's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>